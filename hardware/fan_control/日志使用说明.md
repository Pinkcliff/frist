# 风扇控制日志使用说明

## 日志文件位置

所有日志文件保存在：
```
hardware/fan_control/logs/
```

文件命名格式：
```
fan_control_YYYYMMDD_HHMMSS.log
```

例如：`fan_control_20260103_203351.log`

## 日志文件内容

每条日志记录包含以下信息：

### 1. 基础信息
- **时间戳**：精确到毫秒（例如：2026-01-03 20:33:51.820）
- **日志级别**：
  - `INFO` - 重要信息
  - `DEBUG` - 调试信息
  - `ERROR` - 错误信息

### 2. 风扇控制详情

对于每个风扇控制操作，日志会记录：

#### 单个风扇控制示例
```
2026-01-03 20:33:51.820 | INFO     | 设置风扇 #1 速度
2026-01-03 20:33:51.820 | DEBUG    |   风扇索引: 0 (0-based)
2026-01-03 20:33:51.820 | DEBUG    |   速度百分比: 25.00%
2026-01-03 20:33:51.820 | DEBUG    |   PWM值: 250
2026-01-03 20:33:51.820 | DEBUG    |   寄存器地址: 0x0000
2026-01-03 20:33:51.820 | DEBUG    |   请求帧: 01 06 00 00 00 FA 09 89
2026-01-03 20:33:51.820 | ERROR    |   [ERROR] 失败: 未连接
```

**字段说明**：
- `风扇索引`：内部0-based索引（0-15）
- `速度百分比`：用户可见的速度（0-100%）
- `PWM值`：实际发送到硬件的值（0-1000）
- `寄存器地址`：Modbus寄存器地址（0x0000-0x000F）
- `请求帧`：完整的Modbus RTU十六进制帧
- `操作结果`：成功或失败

#### Modbus RTU帧结构
```
01 06 00 00 00 FA 09 89
│  │  │  │  │     │
│  │  │  │  │     └─ CRC校验码（低字节）
│  │  │  │  │     └─ CRC校验码（高字节）
│  │  │  │  └──────── 数据值（0x00FA = 250）
│  │  │  └─────────── 寄存器地址（低字节）
│  │  └────────────── 寄存器地址（高字节）
│  └───────────────── 功能码（0x06 = 写单个寄存器）
└──────────────────── 从站地址（1）
```

### 3. 批量风扇控制

#### 所有风扇相同速度
```
2026-01-03 20:33:51.821 | INFO     | 设置所有风扇速度
2026-01-03 20:33:51.821 | DEBUG    |   速度百分比: 50.00%
2026-01-03 20:33:51.821 | DEBUG    |   PWM值: 500 (所有16个风扇)
2026-01-03 20:33:51.821 | DEBUG    |   起始地址: 0x0000
2026-01-03 20:33:51.821 | DEBUG    |   PWM列表: [500, 500, 500, 500, 500]...
2026-01-03 20:33:51.821 | DEBUG    |   请求长度: 41 字节
```

#### 分别设置每个风扇
```
2026-01-03 20:33:51.821 | INFO     | 分别设置每个风扇速度
2026-01-03 20:33:51.821 | DEBUG    |   风扇数量: 16
2026-01-03 20:33:51.821 | DEBUG    |   风扇#1: 0.0% -> PWM:0 -> 寄存器0x0000
2026-01-03 20:33:51.821 | DEBUG    |   风扇#2: 6.7% -> PWM:66 -> 寄存器0x0001
2026-01-03 20:33:51.821 | DEBUG    |   风扇#3: 13.3% -> PWM:133 -> 寄存器0x0002
...
2026-01-03 20:33:51.822 | DEBUG    |   风扇#16: 100.0% -> PWM:1000 -> 寄存器0x000F
2026-01-03 20:33:51.822 | INFO     |   [OK] 成功: 分别设置16个风扇
```

### 4. 统计信息

日志文件末尾包含统计摘要：
```
2026-01-03 20:33:51.823 | INFO     | ============================================================
2026-01-03 20:33:51.823 | INFO     | 风扇控制统计
2026-01-03 20:33:51.823 | INFO     | 总命令数: 8
2026-01-03 20:33:51.823 | INFO     | 成功命令: 0
2026-01-03 20:33:51.823 | INFO     | 失败命令: 8
2026-01-03 20:33:51.823 | INFO     | 连接错误: 0
2026-01-03 20:33:51.824 | INFO     | 成功率: 0.0%
2026-01-03 20:33:51.824 | INFO     | ============================================================
```

## 使用日志记录功能

### 方式1：自动记录（默认）
```python
from hardware.fan_control import ModbusFanController, FanConfig

# 创建控制器（默认启用日志）
config = FanConfig(device_ip="192.168.2.1")
controller = ModbusFanController(config)  # enable_logging=True 默认

# 所有操作会自动记录到日志
controller.set_all_fans_speed(50.0)
```

### 方式2：禁用日志
```python
# 创建控制器（禁用日志）
controller = ModbusFanController(config, enable_logging=False)
```

### 方式3：自定义日志文件
```python
from hardware.fan_control import setup_fan_logger, ModbusFanController, FanConfig

# 设置自定义日志文件
import os
log_file = os.path.join('custom_path', 'my_fan_log.log')
logger = setup_fan_logger(log_file)

# 控制器会使用这个日志记录器
controller = ModbusFanController(config)
```

## 生成演示日志

运行演示脚本生成示例日志：
```bash
cd hardware/fan_control
python generate_demo_log.py
```

或运行快速测试：
```bash
python test_log.py
```

## 日志分析

### 查找特定风扇的控制记录
```bash
grep "风扇 #1" logs/fan_control_*.log
```

### 查找所有成功操作
```bash
grep "\[OK\]" logs/fan_control_*.log
```

### 查找所有失败操作
```bash
grep "\[ERROR\]" logs/fan_control_*.log
```

### 统计操作次数
```bash
grep "设置风扇" logs/fan_control_*.log | wc -l
```

## 日志级别说明

| 级别 | 用途 | 示例 |
|------|------|------|
| INFO | 重要操作和状态变化 | 连接成功、设置风扇、统计信息 |
| DEBUG | 详细的调试信息 | 寄存器地址、PWM值、请求帧 |
| ERROR | 错误和异常 | 连接失败、设置失败、超时 |

## 典型日志示例

### 成功的控制流程
```
2026-01-03 20:33:51 | INFO | ModbusFanController 初始化
2026-01-03 20:33:51 | INFO | 设备IP: 192.168.2.1:8234
2026-01-03 20:33:51 | INFO | 风扇数量: 16
2026-01-03 20:33:52 | INFO | 尝试连接到风扇控制器: 192.168.2.1:8234
2026-01-03 20:33:52 | INFO | [OK] 连接成功
2026-01-03 20:33:52 | INFO | 设置风扇 #1 速度
2026-01-03 20:33:52 | DEBUG |   速度百分比: 50.00%
2026-01-03 20:33:52 | DEBUG |   PWM值: 500
2026-01-03 20:33:52 | DEBUG |   寄存器地址: 0x0000
2026-01-03 20:33:52 | DEBUG |   请求帧: 01 06 00 00 01 F4 89 DD
2026-01-03 20:33:52 | INFO |   [OK] 成功: 风扇#1 -> 50.0% (PWM: 500)
```

### 失败的控制流程（未连接）
```
2026-01-03 20:33:51 | INFO | 设置风扇 #1 速度
2026-01-03 20:33:51 | DEBUG |   速度百分比: 50.00%
2026-01-03 20:33:51 | DEBUG |   PWM值: 500
2026-01-03 20:33:51 | DEBUG |   寄存器地址: 0x0000
2026-01-03 20:33:51 | DEBUG |   请求帧: 01 06 00 00 01 F4 89 DD
2026-01-03 20:33:51 | ERROR |   [ERROR] 失败: 未连接
```

## 注意事项

1. **日志文件大小**：
   - 每次控制操作约生成5-10行日志
   - 长时间运行会产生大量日志
   - 建议定期清理旧日志文件

2. **性能影响**：
   - 日志记录会轻微影响性能
   - 禁用日志可以提高性能
   - 生产环境可以考虑只记录INFO级别

3. **存储空间**：
   - 日志文件保存在 `hardware/fan_control/logs/` 目录
   - 定期清理以避免占用过多磁盘空间

4. **调试建议**：
   - 开发阶段保留所有日志（DEBUG级别）
   - 生产环境只保留重要日志（INFO级别）
   - 使用日志文件快速定位问题

## 日志文件管理

### 查看所有日志文件
```python
import glob
log_files = glob.glob('hardware/fan_control/logs/*.log')
for log_file in sorted(log_files):
    print(f"- {log_file} ({os.path.getsize(log_file)} bytes)")
```

### 清理旧日志
```python
import os
import glob
import time

# 删除7天前的日志
cutoff_time = time.time() - (7 * 24 * 3600)
log_files = glob.glob('hardware/fan_control/logs/*.log')

for log_file in log_files:
    if os.path.getmtime(log_file) < cutoff_time:
        os.remove(log_file)
        print(f"Deleted: {log_file}")
```

## 常见问题

### Q1: 日志文件在哪里？
A: `hardware/fan_control/logs/` 目录下，文件名格式为 `fan_control_YYYYMMDD_HHMMSS.log`

### Q2: 如何禁用日志？
A: 创建控制器时设置 `enable_logging=False`

### Q3: 日志文件太大怎么办？
A: 定期清理旧日志，或者只保留INFO级别日志

### Q4: 如何分析日志？
A: 使用grep、findstr等工具搜索特定内容，或用文本编辑器打开查看

### Q5: 日志记录了什么？
A: 每个风扇的编号、速度百分比、PWM值、寄存器地址、Modbus请求帧、操作结果等

## 总结

日志功能详细记录了风扇控制过程，包括：
- ✅ 每个风扇的控制命令
- ✅ 速度百分比和PWM值
- ✅ Modbus寄存器地址
- ✅ 完整的Modbus RTU请求帧（十六进制）
- ✅ 操作结果（成功/失败）
- ✅ 统计信息和错误详情

这些日志对于调试、问题追踪和性能分析非常有用！
