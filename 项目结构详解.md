# 微小型无人机智能风场测试评估系统 - 项目结构详解

## 一、项目概述

本项目是一个专业的**微小型无人机智能风场测试评估系统**，用于风洞测试环境中的数据采集、风场控制和实时监控。系统采用模块化设计，包含仪表盘监控、风场设置和CFD前处理三大核心模块。

---

## 二、技术栈

| 类别 | 技术 | 版本 |
|------|------|------|
| **编程语言** | Python | 3.11.13 |
| **UI框架** | PySide6 (Qt6) | 6.10.1 |
| **3D可视化** | PyVista + VTK | 0.46.4 + 9.5.2 |
| **图表绘制** | PyQtGraph | 0.14.0 |
| **数值计算** | NumPy | 2.3.5 |
| **数据处理** | Pandas | 2.3.3 |
| **其他依赖** | matplotlib, plotly, redis, requests | - |

---

## 三、项目目录结构

```
frist/
├── main.py                      # 主入口 - 启动仪表盘程序
├── .gitignore                   # Git忽略配置
├── .vscode/                     # VS Code配置
├── .claude/                     # Claude Code配置
├── __pycache__/                 # Python缓存目录
│
├── 背景.png                     # 仪表盘背景图
├── 动捕.png                     # 动捕模块相关图片
├── 风场.png                     # 风场模块相关图片
│
├── 测试报告.md                  # 项目测试报告
├── 项目结构说明.md              # 项目结构文档（旧版）
│
├── 仪表盘/                      # 全局监控仪表盘模块
│   ├── main.py                  # 仪表盘入口
│   ├── ui_main_window.py        # 主窗口类
│   ├── ui_docks.py              # Dock面板定义
│   ├── ui_custom_widgets.py     # 自定义UI组件
│   ├── ui_chart_widget.py       # 图表组件
│   ├── ui_motion_capture.py     # 动捕相关UI
│   ├── core_theme_manager.py    # 主题管理器
│   └── core_data_simulator.py   # 数据模拟器
│
├── 风场设置/                    # 风场设置/风墙控制模块
│   ├── main.py                  # 风场设置入口
│   └── main_control/            # 核心控制模块
│       ├── main_window.py       # 主窗口
│       ├── canvas_widget.py     # 风扇阵列画布
│       ├── floating_windows.py  # 浮动工具窗口
│       ├── timeline_widget.py   # 时间轴组件
│       ├── commands.py          # 撤销/重做命令
│       ├── properties_panel.py  # 属性面板
│       ├── simulation_interface.py  # 仿真接口
│       ├── template_library.py  # 模板库
│       ├── config.py            # 配置参数
│       └── utils.py             # 工具函数
│
└── 前处理/                      # CFD前处理模块
    ├── main.py                  # 前处理入口
    └── CFD_module/              # CFD核心模块
        ├── pre_processor_window.py   # 主窗口逻辑（1000+行）
        ├── ui_main_window.py         # UI布局定义
        ├── scene_generator.py        # 3D场景生成
        ├── file_handler.py           # 文件处理
        ├── fan_id_generator.py       # 风扇ID生成器
        ├── grid_utils.py             # 网格工具
        ├── pre_processor_config.py   # 配置参数
        └── fan_curve_14600.txt       # 风扇PQ曲线数据
```

---

## 四、核心模块详解

### 4.1 仪表盘模块 (`仪表盘/`)

**功能**: 全局系统监控和数据可视化

**核心文件**:

| 文件 | 大小 | 功能描述 |
|------|------|----------|
| `ui_main_window.py` | 21.8KB | 仪表盘主窗口类 |
| `ui_docks.py` | 59.3KB | 15个监控面板定义 |
| `ui_custom_widgets.py` | 14.8KB | 自定义UI组件（指示器、拖拽框等） |
| `ui_chart_widget.py` | 3.1KB | 实时图表组件 |
| `ui_motion_capture.py` | 12.5KB | 动捕相机状态监控 |
| `core_theme_manager.py` | 11.2KB | 深色/浅色主题管理 |
| `core_data_simulator.py` | 2.1KB | 数据模拟器 |

**主要功能**:
- 实时监控15个面板（系统状态、通讯、电流、电压、功率、环境等）
- 支持20个动捕相机的状态监控
- 主题切换（深色/浅色）
- 急停和开关机控制
- 系统标定和训练功能

**启动方式**:
```bash
python main.py
# 或
python 仪表盘/main.py
```

---

### 4.2 风场设置模块 (`风场设置/`)

**功能**: 40x40风扇阵列速度设置与控制

**核心文件**:

| 文件 | 大小 | 功能描述 |
|------|------|----------|
| `main_window.py` | 28.7KB | 主窗口逻辑 |
| `canvas_widget.py` | 25.4KB | 风扇阵列可视化画布 |
| `floating_windows.py` | 19.7KB | 工具面板浮动窗口 |
| `timeline_widget.py` | 5.6KB | 时间序列配置 |
| `simulation_interface.py` | - | CFD仿真接口 |
| `template_library.py` | - | 模板保存/加载 |
| `commands.py` | - | 撤销/重做命令模式 |

**主要功能**:
- 40x40风扇阵列可视化编辑
- 多种工具模式：
  - 点选模式
  - 笔刷模式
  - 圆形模式
  - 直线模式
  - 函数模式
- 时间轴配置
- 风扇ID格式：`X000Y000`（列号+行号）
- 模板库（保存/加载配置）
- 启动CFD前处理

**启动方式**:
```bash
python 风场设置/main.py
```

---

### 4.3 前处理模块 (`前处理/`)

**功能**: CFD仿真前处理（参数设置、网格生成、场景生成）

**核心文件**:

| 文件 | 大小 | 功能描述 |
|------|------|----------|
| `pre_processor_window.py` | 52KB | 主窗口逻辑（1000+行核心代码） |
| `scene_generator.py` | 17.7KB | 3D场景生成器 |
| `file_handler.py` | 12.2KB | 文件读写处理 |
| `ui_main_window.py` | 10.1KB | UI布局定义 |
| `fan_id_generator.py` | - | 风扇ID矩阵生成 |
| `grid_utils.py` | - | 网格坐标生成 |
| `fan_curve_14600.txt` | - | 风扇PQ曲线数据 |

**主要功能**:
- CFD参数设置（裕量、入口/出口长度、风扇参数）
- 40x40风扇阵列生成
- 3D可视化（PyVista + VTK）
- 残差监控图表
- 边界条件设置
- 网格生成配置
- 仿真控制

**启动方式**:
```bash
python 前处理/main.py
```

---

## 五、系统架构

### 5.1 模块关系图

```
┌─────────────────────────────────────────────────────────────┐
│                         主程序                               │
│                        main.py                              │
│                  (启动仪表盘程序)                            │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                      仪表盘模块                               │
│                  实时监控各子系统状态                         │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐  │
│  │系统监控  │  │环境监控  │  │电力监控  │  │动捕监控  │  │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ▲
                            │ 数据显示
                            │
        ┌───────────────────┴───────────────────┐
        │                                       │
        ▼                                       ▼
┌───────────────────────┐           ┌───────────────────────┐
│     风场设置模块       │           │     前处理模块         │
│   (独立运行)           │           │   (独立运行)           │
│                       │           │                       │
│ · 风扇阵列配置         │  ──────▶  │ · CFD参数设置         │
│ · 时间序列配置         │           │ · 网格生成            │
│ · 启动前处理           │           │ · 场景生成            │
│                       │           │ · 仿真控制            │
└───────────────────────┘           └───────────────────────┘
```

### 5.2 数据流向

```
用户操作
    │
    ▼
[风场设置] → 配置风扇转速模式
    │
    ├─→ 保存为模板
    │
    └─→ 点击"进入仿真"
         │
         ▼
[前处理模块] → 接收风扇数据
    │
    ├─→ 生成CFD计算网格
    ├─→ 设置边界条件
    └─→ 启动仿真求解器
         │
         ▼
[仿真运行] → 产生计算结果
    │
    ▼
[仪表盘] → 实时显示系统状态
```

### 5.3 通信协议支持

| 协议 | 用途 |
|------|------|
| TCP/IP | 主控制器通信 |
| EtherCAT | 电驱、风速传感器、温度传感器、湿度传感器 |
| Modbus | 俯仰伺服、造雨、喷雾、电力系统 |
| API | 动捕系统、训练系统、仿真系统 |

---

## 六、依赖说明

### 6.1 核心依赖

```python
# UI框架
PySide6==6.10.1
PySide6_Addons==6.10.1
PySide6_Essentials==6.10.1
shiboken6==6.10.1

# 3D可视化
pyvista==0.46.4
pyvistaqt==0.11.3
vtk==9.5.2

# 图表绘制
pyqtgraph==0.14.0
matplotlib==3.10.8
plotly==6.5.0

# 数值计算
numpy==2.3.5
pandas==2.3.3

# 其他
redis==7.1.0
requests==2.32.5
pyserial==3.5
```

### 6.2 安装命令

```bash
# 使用conda环境
conda create -n my_env python=3.11
conda activate my_env

# 安装核心依赖
pip install PySide6==6.10.1
pip install pyvista==0.46.4 pyvistaqt==0.11.3
pip install pyqtgraph==0.14.0
pip install numpy pandas matplotlib plotly
pip install redis requests pyserial
```

---

## 七、开发注意事项

### 7.1 已知问题

1. **代码重复**: `仪表盘/ui_docks.py` 中存在严重的函数重复定义问题
2. **导入错误**: 求解器模块缺失，导致仿真功能无法运行
3. **路径依赖**: 图片加载使用相对路径，运行时需注意工作目录
4. **功能未实现**: 部分文件操作功能尚未完成

### 7.2 开发建议

1. 修复 `ui_docks.py` 的代码重复问题
2. 完善求解器模块的集成
3. 使用绝对路径或资源文件管理图片
4. 添加异常处理和日志记录
5. 编写单元测试

---

## 八、项目特色

| 特性 | 描述 |
|------|------|
| 模块化设计 | 三大模块可独立运行 |
| 专业化界面 | 针对风洞测试环境定制 |
| 3D可视化 | PyVista实现风扇阵列实时显示 |
| 实时监控 | 多参数实时监控和数据可视化 |
| 强大工具支持 | 多种编辑模式和模板库 |
| 工业级通信 | 支持EtherCAT、Modbus等工业协议 |

---

## 九、快速启动

```bash
# 1. 激活环境
conda activate my_env

# 2. 启动仪表盘（主程序）
python main.py

# 3. 启动风场设置
python 风场设置/main.py

# 4. 启动前处理
python 前处理/main.py
```

---

*文档生成时间: 2025-12-30*
