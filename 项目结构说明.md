# 项目结构说明

## 项目概述

这是一个**微小型无人机智能风场测试评估系统**的上位机软件项目，用于风洞测试环境的控制、监控和数据采集。

## 目录结构

```
frist/
├── main.py                 # 主入口文件 - 启动仪表盘程序
├── .gitignore              # Git 忽略配置
├── .vscode/                # VS Code 配置
├── .claude/                # Claude Code 配置
│
├── 背景.png                # 仪表盘背景图
├── 动捕.png                # 动捕模块相关图片
├── 风场.png                # 风场模块相关图片
│
├── 前处理/                 # CFD 前处理模块
│   ├── main.py             # 前处理入口文件
│   ├── __init__.py
│   ├── icon/               # 图标资源 (SVG格式)
│   └── CFD_module/         # CFD 核心模块
│       ├── ui_main_window.py       # UI 布局定义
│       ├── pre_processor_window.py # 主窗口逻辑 (1000+ 行)
│       ├── pre_processor_config.py # 配置参数
│       ├── scene_generator.py      # 3D 场景生成
│       ├── grid_utils.py           # 网格工具
│       ├── file_handler.py         # 文件处理
│       ├── fan_id_generator.py     # 风扇 ID 生成器
│       ├── fan_curve_14600.txt     # 风扇 PQ 曲线数据
│       ├── 00_launch_pre_processor.py
│       ├── 00_single_frame_test.py
│       ├── 00_check_vtm.py
│       ├── 00_debug_check.py
│       └── __pycache__/      # Python 缓存
│
├── 风场设置/               # 风场设置/风墙控制模块
│   ├── main.py             # 风场设置入口文件
│   ├── __init__.py
│   ├── icon/               # 图标资源 (PNG格式)
│   └── main_control/       # 主控制模块
│       ├── main_window.py  # 主窗口逻辑
│       ├── canvas_widget.py # 画布组件 (风扇阵列显示)
│       ├── timeline_widget.py # 时间轴组件
│       ├── commands.py     # 撤销/重做命令
│       ├── config.py       # 配置
│       ├── floating_windows.py   # 浮动窗口 (工具面板)
│       ├── properties_panel.py   # 属性面板
│       ├── simulation_interface.py # 仿真接口
│       ├── template_library.py    # 模板库
│       └── utils.py        # 工具函数
│
└── 仪表盘/                 # 全局监控仪表盘模块
    ├── main.py             # 仪表盘独立入口
    ├── __init__.py
    ├── ui_main_window.py   # 仪表盘主窗口
    ├── ui_custom_widgets.py # 自定义组件
    ├── ui_chart_widget.py  # 图表组件
    ├── ui_docks.py         # Dock 面板定义
    ├── ui_motion_capture.py # 动捕相关
    ├── core_theme_manager.py   # 主题管理
    ├── core_data_simulator.py  # 数据模拟器
    └── debug.py            # 调试工具
```

---

## 核心模块说明

### 1. 主入口 (`main.py`)

- 启动**仪表盘程序**
- 设置 Qt 插件路径
- 应用名称: "无人机仪表盘"

---

### 2. 前处理模块 (`前处理/`)

**功能**: CFD (计算流体力学) 前处理器，用于设置风洞仿真参数和生成计算网格。

**核心文件**:
- `pre_processor_window.py` - 主窗口，包含：
  - 全局参数设置 (裕量、入口/出口长度、风扇参数等)
  - 风扇参数配置 (转速、方向、PQ 曲线)
  - 仿真控制 (运行、暂停、停止)
  - 3D 可视化 (PyVista + VTK)
  - 残差监控图表
  - 边界条件设置
  - 网格生成
  - 风扇阵列生成 (40x40 阵列)

**关键类**:
- `MainWindow` - 前处理主窗口
- `SceneGenerator` - 3D 场景生成器
- `FanGeneratorWorker` - 风扇生成工作线程

---

### 3. 风场设置模块 (`风场设置/`)

**功能**: 风墙风扇阵列的速度控制和时间序列设置。

**核心文件**:
- `main_window.py` - 主窗口，包含：
  - 40x40 风扇阵列可视化
  - 多种工具模式 (点选、笔刷、圆形、直线、函数)
  - 时间轴控制 (播放/暂停)
  - 风扇设置 (最大转速)
  - 时间设置 (最大时间、分辨率)
  - 模板库
  - 撤销/重做功能
  - 启动 CFD 前处理

**工具窗口** (`floating_windows.py`):
- `SelectionInfoWindow` - 选择工具面板
- `BrushToolWindow` - 笔刷工具面板
- `CircleToolWindow` - 圆形工具面板
- `LineToolWindow` - 直线工具面板
- `FunctionToolWindow` - 函数生成器
- `FanSettingsWindow` - 风扇设置
- `TimeSettingsWindow` - 时间设置
- `TemplateLibraryWindow` - 模板库

**风扇 ID 格式**: `X000Y000` (列号 + 行号)

---

### 4. 仪表盘模块 (`仪表盘/`)

**功能**: 全局监控仪表盘，实时显示系统状态、环境数据、电力参数等。

**Dock 面板** (`ui_docks.py`):
| 面板名称 | 功能描述 |
|---------|---------|
| 系统 | 系统健康状态、设备状态 |
| 通讯 | 各模块通讯状态 (TCP/IP, EtherCAT, Modbus, API) |
| 电流 | 实时电流监控图表 |
| 电压 | 实时电压监控图表 |
| 功率 | 实时功率监控图表 |
| 环境 | 温度、湿度、气压等环境参数 |
| 日志 | 系统日志、活动告警 |
| 俯仰 | 俯仰伺服控制 |
| 风机 | 风机状态控制 |
| 造雨 | 造雨系统控制 |
| 示踪 | 示踪剂控制 |
| 动捕 | 动捕相机状态 (20个相机) |
| 标定 | 系统标定 |
| 仿真 | 仿真模块 |
| 训练 | 训练模块 |
| 设置 | 通讯协议设置 |
| 相机详细设置 | 单个相机参数设置 |
| 动捕视场 | 动捕实时视场 |

**控制功能**:
- 急停按钮
- 开/关机按钮
- 主题切换 (深色/浅色)

---

## 技术栈

- **UI 框架**: PySide6 (Qt 6 for Python)
- **3D 可视化**: PyVista + VTK
- **图表**: PyQtGraph
- **数值计算**: NumPy
- **多进程**: multiprocessing

---

## 模块间关系

```
主程序 (main.py)
    │
    └──> 启动仪表盘 (仪表盘/)
            │
            ├──> 系统监控
            ├──> 环境监控
            ├──> 电力监控
            └──> 各子系统控制

风场设置 (风场设置/)
    │
    ├──> 风扇阵列速度设置
    ├──> 时间序列配置
    └──> 启动前处理 → 前处理模块

前处理 (前处理/)
    │
    ├──> CFD 参数设置
    ├──> 网格生成
    ├──> 风扇阵列生成
    └──> 仿真控制
```

---

## 启动方式

1. **仪表盘程序**:
   ```bash
   python main.py
   ```

2. **前处理程序** (独立运行):
   ```bash
   python 前处理/main.py
   ```

3. **风场设置程序** (独立运行):
   ```bash
   python 风场设置/main.py
   ```

---

## 数据流

1. 用户在**风场设置**中配置风扇转速模式
2. 点击"进入仿真"启动**前处理模块**
3. 前处理接收风扇数据并生成 CFD 计算网格
4. 仿真运行后，**仪表盘**实时显示系统状态
